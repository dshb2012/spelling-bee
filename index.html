<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Spelling Bee - Writing Practice</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f8fafc;
}

/* ===== CONTROL PANEL ===== */
#controlPanel {
  position: sticky;
  top: 0;
  z-index: 1000;

  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;

  background: #ffffff;
  padding: 14px;
  border-bottom: 2px solid #e0e0e0;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

#controlPanel button {
  border: none;
  border-radius: 10px;
  padding: 10px 16px;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
}

/* Play All */
#controlPanel button:nth-child(1) {
  background: #22c55e;
  color: white;
}

/* Pause */
#controlPanel button:nth-child(2) {
  background: #facc15;
  color: #333;
}

/* Stop */
#controlPanel button:nth-child(3) {
  background: #ef4444;
  color: white;
}

/* Bell */
#bellBtn {
  background: #3b82f6;
  color: white;
}

#timerDisplay,
#progressDisplay {
  margin-left: auto;
  background: #f1f5f9;
  padding: 8px 12px;
  border-radius: 10px;
  font-weight: bold;
}

/* ===== TITLE ===== */
#appTitle {
  text-align: center;
  margin: 18px 0;
  color: #2563eb;
}

/* ===== TABLE ===== */
table {
  width: 100%;
  border-collapse: collapse;
}

th {
  background: #e0e7ff;
  padding: 10px;
}

td {
  padding: 8px;
  border-bottom: 1px solid #ddd;
}

tr.active {
  background: #fff6cc;
}

.spellBtn {
  background: #6366f1;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 6px 10px;
  cursor: pointer;
}
</style>
</head>

<body>

<!-- CONTROL PANEL -->
<div id="controlPanel">
  <button onclick="playAll()">‚ñ∂ Play All</button>
  <button onclick="pauseResume()">‚è∏ Pause / Resume</button>
  <button onclick="stopPlay()">‚èπ Stop</button>

  <span>
    Start row:
    <input type="number" id="startRow" value="1" min="1" style="width:60px;">
    <button onclick="playFromRow()">‚ñ∂</button>
  </span>

  <button id="bellBtn" onclick="toggleBell()">üîî Bell ON</button>

  <span id="timerDisplay">‚è± 20</span>
  <span id="progressDisplay">üìò 0 / 0</span>
</div>

<h1 id="appTitle">Spelling Bee ‚Äì Writing Practice</h1>

<input type="file" accept=".csv" onchange="loadCSV(event)" style="margin:10px;">

<table>
<thead>
<tr>
  <th>No.</th>
  <th>Word</th>
  <th>Sentence</th>
  <th>Word</th>
  <th>Spelling</th>
</tr>
</thead>
<tbody id="dataTable"></tbody>
</table>

<script>
let rows = [];
let currentRow = 0;
let playing = false;
let paused = false;
let bellMuted = false;
let completedRows = 0;
let timerInterval;
let beepCtx;

/* ===== UTIL ===== */
const wait = ms => new Promise(r => setTimeout(r, ms));

function speak(text) {
  return new Promise(resolve => {
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "en-US";
    u.onend = resolve;
    speechSynthesis.speak(u);
  });
}

/* ===== BEEP ===== */
function beep(freq=800, dur=0.15) {
  if (bellMuted) return;
  if (!beepCtx) beepCtx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = beepCtx.createOscillator();
  const gain = beepCtx.createGain();
  osc.frequency.value = freq;
  osc.connect(gain);
  gain.connect(beepCtx.destination);
  osc.start();
  gain.gain.exponentialRampToValueAtTime(0.001, beepCtx.currentTime + dur);
  osc.stop(beepCtx.currentTime + dur);
}

/* ===== LOAD CSV ===== */
function loadCSV(e) {
  const reader = new FileReader();
  reader.onload = () => {
    rows = reader.result.split("\n").map(r => r.split(","));
    renderTable();
    completedRows = 0;
    updateProgress();
  };
  reader.readAsText(e.target.files[0]);
}

/* ===== RENDER ===== */
function renderTable() {
  const tb = document.getElementById("dataTable");
  tb.innerHTML = "";
  rows.forEach((r,i) => {
    const tr = document.createElement("tr");
    r.forEach(c => {
      const td = document.createElement("td");
      td.textContent = c;
      tr.appendChild(td);
    });
    const td = document.createElement("td");
    const btn = document.createElement("button");
    btn.textContent = "üî§ Spell";
    btn.className = "spellBtn";
    btn.onclick = () => spellingRow(i);
    td.appendChild(btn);
    tr.appendChild(td);
    tb.appendChild(tr);
  });
}

/* ===== PLAY ===== */
async function playRow(i) {
  document.querySelectorAll("tr").forEach(r => r.classList.remove("active"));
  document.querySelectorAll("tr")[i+1].classList.add("active");

  await speak(rows[i][1]);
  await wait(500);
  await speak(rows[i][2]);
  await wait(500);
  await speak(rows[i][3]);

  completedRows++;
  updateProgress();
  await startTimer();
}

async function playAll() {
  stopPlay();
  playing = true;
  completedRows = 0;
  updateProgress();
  for (currentRow = 0; currentRow < rows.length && playing; currentRow++) {
    while (paused) await wait(300);
    await playRow(currentRow);
  }
}

function playFromRow() {
  currentRow = Math.max(0, document.getElementById("startRow").value - 1);
  playAll();
}

function pauseResume() {
  paused = !paused;
}

function stopPlay() {
  playing = false;
  paused = false;
  speechSynthesis.cancel();
  clearInterval(timerInterval);
}

/* ===== TIMER ===== */
function startTimer() {
  return new Promise(resolve => {
    let t = 20;
    timerDisplay.textContent = `‚è± ${t}`;
    timerInterval = setInterval(() => {
      t--;
      timerDisplay.textContent = `‚è± ${t}`;
      if (t <= 5 && t > 0) beep(1200);
      else if (t <= 10 && t > 5 && t % 2 === 0) beep(900);
      if (t <= 0) {
        beep(600, 0.4);
        clearInterval(timerInterval);
        resolve();
      }
    }, 1000);
  });
}

/* ===== SPELLING ===== */
async function spellingRow(i) {
  const w = rows[i][3];
  if (!w) return;
  await speak(w);
  await wait(400);
  for (let c of w) {
    await speak(c);
    await wait(400);
  }
  await speak(w);
}

/* ===== UI ===== */
function toggleBell() {
  bellMuted = !bellMuted;
  bellBtn.textContent = bellMuted ? "üîï Bell OFF" : "üîî Bell ON";
}

function updateProgress() {
  progressDisplay.textContent = `üìò ${completedRows} / ${rows.length}`;
}
</script>
</body>
</html>
