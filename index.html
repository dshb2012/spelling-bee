<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spelling Bee</title>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding-top: 60px;
}

#timerBox {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: #1976d2;
  color: white;
  font-size: 18px;
  text-align: center;
  padding: 10px;
  z-index: 9999;
}

.controls {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin: 10px;
}

button {
  padding: 8px 12px;
  font-size: 14px;
}

button:disabled {
  opacity: 0.5;
}

table {
  width: 100%;
  border-collapse: collapse;
}

td, th {
  border: 1px solid #ccc;
  padding: 6px;
}

tr.active {
  background: #c8e6ff;
}
</style>
</head>

<body>

<div id="timerBox">Timer: -</div>

<div class="controls">
  <input type="file" id="fileInput" accept=".csv">
  <button onclick="playAll()">‚ñ∂ Play All</button>
  <button onclick="pausePlay()">‚è∏ Pause</button>
  <button onclick="resumePlay()">‚ñ∂ Resume</button>
  <button onclick="stopPlay()">‚èπ Stop</button>

  <input type="number" id="startRow" placeholder="Baris ke..." style="width:90px">
  <button onclick="playFromRow()">üî¢ Play dari Baris</button>
</div>

<table id="dataTable"></table>

<script>
let rows = [];
let stopped = false;
let paused = false;
let playingAll = false;

const GAP_COL = 500;   // ‚úÖ 0.5 detik antar kolom
const GAP_SPELL = 400; // 0.4 detik spelling
const ROW_DELAY = 20;  // 20 detik antar baris

document.getElementById("fileInput").addEventListener("change", loadCSV);

function loadCSV(e) {
  const reader = new FileReader();
  reader.onload = () => {
    rows = reader.result
      .trim()
      .split("\n")
      .map(r => r.split(",").map(c => c.trim()));
    renderTable();
  };
  reader.readAsText(e.target.files[0]);
}

function renderTable() {
  const table = document.getElementById("dataTable");
  table.innerHTML = "";

  rows.forEach((r, i) => {
    const tr = document.createElement("tr");

    r.forEach(cell => {
      const td = document.createElement("td");
      td.textContent = cell;
      tr.appendChild(td);
    });

    const tdSpell = document.createElement("td");
    const btn = document.createElement("button");
    btn.textContent = "üî§ Spelling";
    btn.onclick = () => spellingRow(i);
    tdSpell.appendChild(btn);
    tr.appendChild(tdSpell);

    table.appendChild(tr);
  });
}

/* ===================== PLAY ===================== */

async function playAll() {
  stopPlay();
  stopped = false;
  paused = false;
  playingAll = true;

  for (let i = 0; i < rows.length; i++) {
    if (stopped) break;
    await playRow(i);
  }

  playingAll = false;
}

function playFromRow() {
  stopPlay();
  stopped = false;
  paused = false;
  playingAll = true;

  const start = parseInt(document.getElementById("startRow").value) - 1;
  if (isNaN(start) || start < 0 || start >= rows.length) {
    playingAll = false;
    return;
  }

  (async () => {
    for (let i = start; i < rows.length; i++) {
      if (stopped) break;
      await playRow(i);
    }
    playingAll = false;
  })();
}

function pausePlay() {
  paused = true;
  speechSynthesis.pause();
}

function resumePlay() {
  paused = false;
  speechSynthesis.resume();
}

function stopPlay() {
  stopped = true;
  paused = false;
  playingAll = false;
  speechSynthesis.cancel();
  document.getElementById("timerBox").textContent = "Timer: -";
  clearHighlight();
}

/* ===================== CORE ===================== */

async function playRow(i) {
  highlightRow(i);

  // ‚ùå kolom 1 (nomor) tidak dibaca
  // ‚úÖ kolom 2,3,4 dibaca
  await speak(rows[i][1]);
  await wait(GAP_COL);
  await speak(rows[i][2]);
  await wait(GAP_COL);
  await speak(rows[i][3]);

  await startRowTimer();
}

function speak(text) {
  return new Promise(resolve => {
    if (!text) return resolve();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "en-US";
    u.onend = resolve;
    speechSynthesis.speak(u);
  });
}

function wait(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function startRowTimer() {
  for (let i = ROW_DELAY; i > 0; i--) {
    if (stopped) break;
    document.getElementById("timerBox").textContent = "Next row in " + i + "s";
    await wait(1000);
  }
  document.getElementById("timerBox").textContent = "Timer: -";
}

function highlightRow(i) {
  clearHighlight();
  document.querySelectorAll("tr")[i]?.classList.add("active");
}

function clearHighlight() {
  document.querySelectorAll("tr").forEach(tr => tr.classList.remove("active"));
}

/* ===================== SPELLING (MANUAL) ===================== */

async function spellingRow(i) {
  if (playingAll) return; // ‚ùå tidak jalan saat play all

  const word = rows[i][3];
  if (!word) return;

  speechSynthesis.cancel();

  await speak(word);
  await wait(GAP_SPELL);

  for (let c of word) {
    await speak(c);
    await wait(GAP_SPELL);
  }

  await speak(word);
}
</script>

</body>
</html>
