<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reading Class</title>

<link rel="manifest" href="manifest.json">

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding-top: 60px;
}

#timerBox {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: #d32f2f;
  color: white;
  font-size: 18px;
  text-align: center;
  padding: 10px;
  z-index: 9999;
}

.controls {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin: 10px;
}

button {
  padding: 8px 12px;
  font-size: 14px;
}

button:disabled {
  opacity: 0.5;
}

table {
  width: 100%;
  border-collapse: collapse;
}

td, th {
  border: 1px solid #ccc;
  padding: 6px;
}

tr.active {
  background: #c8e6ff;
}
</style>
</head>

<body>

<div id="timerBox">Timer: -</div>

<div class="controls">
  <input type="file" id="fileInput" accept=".csv">
  <button onclick="playAll()">‚ñ∂ Play All</button>
  <button onclick="pausePlay()">‚è∏ Pause</button>
  <button onclick="resumePlay()">‚ñ∂ Resume</button>
  <button onclick="stopPlay()">‚èπ Stop</button>

  <input type="number" id="startRow" placeholder="Baris ke..." style="width:90px">
  <button onclick="playFromRow()">üî¢ Play dari Baris</button>
</div>

<table id="dataTable"></table>

<script>
let rows = [];
let stopped = false;
let paused = false;
let isPlaying = false; // kunci spelling saat play all

const GAP = 400;      // 0.4 detik antar kolom
const ROW_DELAY = 20; // 20 detik antar baris

document.getElementById("fileInput").addEventListener("change", loadCSV);

function loadCSV(e) {
  const reader = new FileReader();
  reader.onload = () => {
    rows = reader.result.trim().split("\n").map(r => r.split(","));
    renderTable();
  };
  reader.readAsText(e.target.files[0]);
}

function renderTable() {
  const table = document.getElementById("dataTable");
  table.innerHTML = "";

  rows.forEach((r, i) => {
    const tr = document.createElement("tr");

    // tampilkan semua kolom CSV
    r.forEach(cell => {
      const td = document.createElement("td");
      td.textContent = cell;
      tr.appendChild(td);
    });

    // tombol spelling
    const tdSpell = document.createElement("td");
    const btn = document.createElement("button");
    btn.textContent = "üî§ Spelling";
    btn.className = "spellBtn";
    btn.onclick = () => spellingRow(i);
    tdSpell.appendChild(btn);
    tr.appendChild(tdSpell);

    table.appendChild(tr);
  });
}

async function playAll() {
  stopPlay();
  stopped = false;
  paused = false;
  isPlaying = true;
  toggleSpelling(false);

  for (let i = 0; i < rows.length; i++) {
    if (stopped) break;
    await playRow(i);
  }

  isPlaying = false;
  toggleSpelling(true);
}

function playFromRow() {
  stopPlay();
  stopped = false;
  paused = false;
  isPlaying = true;
  toggleSpelling(false);

  const start = parseInt(document.getElementById("startRow").value) - 1;
  if (isNaN(start) || start < 0 || start >= rows.length) {
    isPlaying = false;
    toggleSpelling(true);
    return;
  }

  (async () => {
    for (let i = start; i < rows.length; i++) {
      if (stopped) break;
      await playRow(i);
    }
    isPlaying = false;
    toggleSpelling(true);
  })();
}

function pausePlay() {
  paused = true;
  speechSynthesis.pause();
}

function resumePlay() {
  paused = false;
  speechSynthesis.resume();
}

function stopPlay() {
  stopped = true;
  paused = false;
  isPlaying = false;
  speechSynthesis.cancel();
  document.getElementById("timerBox").textContent = "Timer: -";
  clearHighlight();
  toggleSpelling(true);
}

async function playRow(i) {
  highlightRow(i);

  // Kolom: A=nomor (0) ‚ùå, B=kata (1) ‚úÖ, C=kalimat (2) ‚úÖ, D=kata (3) ‚úÖ
  await speak(rows[i][1]);
  await wait(GAP);
  await speak(rows[i][2]);
  await wait(GAP);
  await speak(rows[i][3]);

  await startRowTimer();
}

function speak(text) {
  return new Promise(resolve => {
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "en-US";
    u.onend = resolve;
    speechSynthesis.speak(u);
  });
}

function wait(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function startRowTimer() {
  for (let i = ROW_DELAY; i > 0; i--) {
    if (stopped) break;
    document.getElementById("timerBox").textContent = "Next row in " + i + "s";
    await wait(1000);
  }
  document.getElementById("timerBox").textContent = "Timer: -";
}

function highlightRow(i) {
  clearHighlight();
  document.querySelectorAll("tr")[i]?.classList.add("active");
}

function clearHighlight() {
  document.querySelectorAll("tr").forEach(tr => tr.classList.remove("active"));
}

// üî§ SPELLING ‚Äî HANYA JALAN JIKA DIKLIK MANUAL
async function spellingRow(i) {
  if (isPlaying) return; // tidak boleh saat play all

  const word = rows[i][3];
  if (!word) return;

  await speak(word);
  await wait(300);

  for (let c of word) {
    await speak(c);
    await wait(300);
  }

  await speak(word);
}

function toggleSpelling(enable) {
  document.querySelectorAll(".spellBtn").forEach(btn => {
    btn.disabled = !enable;
  });
}

// PWA
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
